<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3: ‡πÄ‡∏ã‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #06b6d4;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, var(--bg-light) 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: var(--bg-white);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            width: 37.5%;
            transition: width 0.3s ease;
        }
        .lesson-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        .xp-display {
            font-size: 1.1rem;
            color: var(--success-color);
            font-weight: 600;
            margin-top: 12px;
        }
        .theory-card {
            background: var(--bg-white);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
        }
        .theory-card h3 {
            color: var(--primary-color);
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .theory-content { line-height: 1.8; color: var(--text-primary); }
        .example-box {
            background: var(--bg-light);
            border-left: 4px solid var(--secondary-color);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 10px 10px 0;
        }
        .game-container {
            background: var(--bg-white);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
        }
        .game-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
            text-align: center;
        }
        .matching-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            margin: 2rem 0;
        }
        .matching-column {
            background: var(--bg-light);
            border-radius: 15px;
            padding: 1.5rem;
        }
        .column-title {
            text-align: center;
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
        }
        .matching-item {
            background: var(--bg-white);
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 1rem;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
            user-select: none;
        }
        .matching-item:hover {
            border-color: var(--primary-color);
            background: #f0f4ff;
        }
        .matching-item.selected {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
            transform: scale(1.05);
        }
        .matching-item.correct {
            border-color: var(--success-color);
            background: var(--success-color);
            color: white;
        }
        .matching-item.incorrect {
            border-color: var(--error-color);
            background: var(--error-color);
            color: white;
        }
        .matching-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .score-display {
            text-align: center;
            font-size: 1.3rem;
            color: var(--primary-color);
            margin: 2rem 0;
            font-weight: 600;
        }
        .buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Kanit', sans-serif;
        }
        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .btn-secondary {
            background: #f5f5f5;
            color: var(--text-primary);
        }
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        .result-message {
            text-align: center;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            display: none;
        }
        .result-message.success {
            background: #d1fae5;
            color: var(--success-color);
            border: 2px solid var(--success-color);
        }
        .result-message.error {
            background: #fee2e2;
            color: var(--error-color);
            border: 2px solid var(--error-color);
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--primary-color);
            animation: confetti-fall 3s linear infinite;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .lesson-title { font-size: 2rem; }
            .buttons { flex-direction: column; }
            .matching-container { grid-template-columns: 1fr; gap: 2rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <h1 class="lesson-title">‚öñÔ∏è ‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3: ‡πÄ‡∏ã‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô</h1>
            <div class="xp-display">
                <span id="xp-display">XP: 0</span>
            </div>
        </div>

        <div class="theory-card">
            <h3>üìê ‡∏ó‡∏§‡∏©‡∏é‡∏µ‡πÄ‡∏ã‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô</h3>
            <div class="theory-content">
                <p><strong>‡πÄ‡∏ã‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô</strong> ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏ã‡∏ï‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß</p>
                
                <div class="example-box">
                    <strong>‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ç‡∏≠‡∏á‡πÄ‡∏ã‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô:</strong><br>
                    1. ‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß<br>
                    2. ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç<br>
                    3. ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
                </div>

                <div class="example-box">
                    <strong>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:</strong><br>
                    ‚Ä¢ A = {1, 2, 3} ‡πÅ‡∏•‡∏∞ B = {3, 2, 1} ‚Üí A = B<br>
                    ‚Ä¢ C = {a, b, c} ‡πÅ‡∏•‡∏∞ D = {a, b, c, c} ‚Üí C = D<br>
                    ‚Ä¢ E = {1, 2} ‡πÅ‡∏•‡∏∞ F = {1, 2, 3} ‚Üí E ‚â† F
                </div>

                <div class="example-box">
                    <strong>‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå:</strong><br>
                    ‚Ä¢ A = B ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á ‡πÄ‡∏ã‡∏ï A ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏ï B<br>
                    ‚Ä¢ A ‚â† B ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á ‡πÄ‡∏ã‡∏ï A ‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏ï B
                </div>
            </div>
        </div>

        <div class="game-container">
            <h2 class="game-title">üéÆ ‡πÄ‡∏Å‡∏°‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà: ‡∏´‡∏≤‡πÄ‡∏ã‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô</h2>
            <p style="text-align: center; color: #666; margin-bottom: 2rem;">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ã‡∏ï‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ã‡πâ‡∏≤‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡∏ß‡∏≤</p>
            
            <div class="score-display">
                ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="gameScore">0</span> / 6
            </div>

            <div class="matching-container">
                <div class="matching-column">
                    <div class="column-title">‡πÄ‡∏ã‡∏ï‡∏Ñ‡∏π‡πà</div>
                </div>

                <div class="matching-column">
                    <div class="column-title">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå</div>
                </div>
            </div>

            <div class="result-message" id="resultMessage"></div>

            <div class="buttons">
                <button class="btn btn-primary" id="finishLessonBtn" onclick="finishLesson()">üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                <button class="btn btn-secondary" onclick="resetGame()">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                <button class="btn btn-secondary" onclick="goHome()">üè† ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π</button>
            </div>
        </div>
    </div>

    <script>
        // XP SYSTEM: Sync with localStorage and update live
        function getXP() {
            return parseInt(localStorage.getItem('setTheoryXP') || '0', 10);
        }
        function setXP(xp) {
            localStorage.setItem('setTheoryXP', xp);
            updateXPDisplay();
        }
        function addXP(amount) {
            let xp = getXP();
            xp += amount;
            setXP(xp);
        }
        function updateXPDisplay() {
            const xp = getXP();
            const el = document.getElementById('xp-display');
            if (el) el.textContent = `XP: ${xp}`;
        }
        window.addEventListener('DOMContentLoaded', updateXPDisplay);

        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏°
        let gameData = {
            currentXP: 0,
            stars: 0,
            selectedPair: null,
            selectedAnswer: null,
            matches: [],
            gameScore: 0
        };

        // ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        const correctMatches = {
            'pair1': 'pair1', // A = B
            'pair2': 'pair2', // C ‚â† D
            'pair3': 'pair3', // E ‚â† F
            'pair4': 'pair4', // G = H
            'pair5': 'pair5', // I = J
            'pair6': 'pair6'  // K ‚â† L
        };

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏Å‡∏°
        function initGame() {
            loadProgress();
            updateUI();
        }

        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏π‡πà‡πÄ‡∏ã‡∏ï
        function selectItem(element) {
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            document.querySelectorAll('.matching-column:first-child .matching-item').forEach(item => {
                item.classList.remove('selected');
            });

            element.classList.add('selected');
            gameData.selectedPair = element.dataset.id;
            playSound('click');

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà
            if (gameData.selectedAnswer) {
                checkMatch();
            }
        }

        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
        function selectAnswer(element) {
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            document.querySelectorAll('.matching-column:last-child .matching-item').forEach(item => {
                item.classList.remove('selected');
            });

            element.classList.add('selected');
            gameData.selectedAnswer = element.dataset.answer;
            playSound('click');

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà
            if (gameData.selectedPair) {
                checkMatch();
            }
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà
        function checkMatch() {
            if (gameData.selectedPair && gameData.selectedAnswer) {
                const isCorrect = correctMatches[gameData.selectedPair] === gameData.selectedAnswer;
                
                const pairElement = document.querySelector(`[data-id="${gameData.selectedPair}"]`);
                const answerElement = document.querySelector(`[data-answer="${gameData.selectedAnswer}"]`);

                if (isCorrect) {
                    // ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                    pairElement.classList.remove('selected');
                    answerElement.classList.remove('selected');
                    pairElement.classList.add('correct', 'disabled');
                    answerElement.classList.add('correct', 'disabled');
                    
                    gameData.matches.push({
                        pair: gameData.selectedPair,
                        answer: gameData.selectedAnswer,
                        correct: true
                    });
                    
                    gameData.gameScore++;
                    updateScore();
                    playSound('success');
                    
                } else {
                    // ‡∏ú‡∏¥‡∏î
                    pairElement.classList.remove('selected');
                    answerElement.classList.remove('selected');
                    pairElement.classList.add('incorrect');
                    answerElement.classList.add('incorrect');
                    
                    setTimeout(() => {
                        pairElement.classList.remove('incorrect');
                        answerElement.classList.remove('incorrect');
                    }, 1000);
                    
                    playSound('error');
                }

                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                gameData.selectedPair = null;
                gameData.selectedAnswer = null;
            }
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function checkAllMatches() {
            if (gameData.gameScore === 6) {
                // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                gameData.currentXP += 150;
                gameData.stars += 3;
                
                const resultMessage = document.getElementById('resultMessage');
                resultMessage.textContent = 'üéâ ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ñ‡∏π‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏π‡πà ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ã‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡∏µ!';
                resultMessage.className = 'result-message success';
                resultMessage.style.display = 'block';
                
                // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á confetti
                playSound('complete');
                showConfetti();
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
                saveProgress();
                
            } else {
                const resultMessage = document.getElementById('resultMessage');
                resultMessage.textContent = `üéÆ ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ${gameData.gameScore} ‡∏Ñ‡∏π‡πà ‡∏à‡∏≤‡∏Å 6 ‡∏Ñ‡∏π‡πà`;
                resultMessage.className = 'result-message error';
                resultMessage.style.display = 'block';
                
                playSound('click');
            }
            
            updateUI();
        }

        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡∏°
        function resetGame() {
            gameData.selectedPair = null;
            gameData.selectedAnswer = null;
            gameData.matches = [];
            gameData.gameScore = 0;
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏∏‡∏Å‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°
            document.querySelectorAll('.matching-item').forEach(item => {
                item.classList.remove('selected', 'correct', 'incorrect', 'disabled');
            });
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            document.getElementById('resultMessage').style.display = 'none';
            
            updateScore();
            playSound('click');
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        function updateScore() {
            document.getElementById('gameScore').textContent = gameData.gameScore;
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
        function updateUI() {
            document.getElementById('currentXP').textContent = gameData.currentXP;
            document.getElementById('currentStars').textContent = gameData.stars;
            document.getElementById('progressFill').style.width = '37.5%'; // 3/8 lessons
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
        function loadProgress() {
            const saved = localStorage.getItem('setTheoryProgress');
            if (saved) {
                const savedData = JSON.parse(saved);
                gameData.currentXP = savedData.totalXP || 0;
                gameData.stars = savedData.totalStars || 0;
            }
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
        function saveProgress() {
            const saved = localStorage.getItem('setTheoryProgress');
            let progressData = saved ? JSON.parse(saved) : {
                totalXP: 0,
                completedLessons: 0,
                totalStars: 0,
                lessonProgress: {}
            };

            progressData.totalXP = gameData.currentXP;
            progressData.totalStars = gameData.stars;
            progressData.lessonProgress[3] = {
                completed: true,
                xp: 150,
                stars: 3
            };

            // ‡∏ô‡∏±‡∏ö‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à
            progressData.completedLessons = Object.keys(progressData.lessonProgress).length;

            localStorage.setItem('setTheoryProgress', JSON.stringify(progressData));
        }

        // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        function playSound(type) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'success':
                    oscillator.frequency.value = 659.25; // E5
                    oscillator.type = 'sine';
                    gainNode.gain.value = 0.3;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                    break;
                    
                case 'complete':
                    // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à
                    oscillator.frequency.value = 523.25; // C5
                    oscillator.type = 'sine';
                    gainNode.gain.value = 0.3;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                    
                    setTimeout(() => {
                        const osc2 = audioContext.createOscillator();
                        const gain2 = audioContext.createGain();
                        osc2.connect(gain2);
                        gain2.connect(audioContext.destination);
                        osc2.frequency.value = 659.25; // E5
                        osc2.type = 'sine';
                        gain2.gain.value = 0.3;
                        osc2.start();
                        osc2.stop(audioContext.currentTime + 0.2);
                        
                        setTimeout(() => {
                            const osc3 = audioContext.createOscillator();
                            const gain3 = audioContext.createGain();
                            osc3.connect(gain3);
                            gain3.connect(audioContext.destination);
                            osc3.frequency.value = 783.99; // G5
                            osc3.type = 'sine';
                            gain3.gain.value = 0.3;
                            osc3.start();
                            osc3.stop(audioContext.currentTime + 0.2);
                        }, 150);
                    }, 100);
                    break;
                    
                case 'error':
                    oscillator.frequency.value = 200;
                    oscillator.type = 'sawtooth';
                    gainNode.gain.value = 0.2;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;
                    
                case 'click':
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    gainNode.gain.value = 0.3;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                    break;
            }
        }

        // ‡πÅ‡∏™‡∏î‡∏á confetti
        function showConfetti() {
            const colors = ['#667eea', '#764ba2', '#4CAF50', '#ff6b6b', '#ffd93d'];
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 2 + 's';
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => {
                        confetti.remove();
                    }, 3000);
                }, i * 50);
            }
        }

        // ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        function goHome() {
            playSound('click');
            window.location.href = 'index.html';
        }

        // SHUFFLE MATCHING PAIRS AND ANSWERS
        const matchingPairs = [
            { id: 'pair1', html: 'A = {1, 2, 3}<br>B = {3, 2, 1}' },
            { id: 'pair2', html: 'C = {a, b, c}<br>D = {a, b, d}' },
            { id: 'pair3', html: 'E = {1, 2}<br>F = {1, 2, 3}' },
            { id: 'pair4', html: 'G = {x, y, z}<br>H = {z, y, x}' },
            { id: 'pair5', html: 'I = {1, 1, 2}<br>J = {1, 2}' },
            { id: 'pair6', html: 'K = {‚àÖ}<br>L = { }' }
        ];
        const matchingAnswers = [
            { id: 'pair1', html: 'A = B' },
            { id: 'pair2', html: 'C ‚â† D' },
            { id: 'pair3', html: 'E ‚â† F' },
            { id: 'pair4', html: 'G = H' },
            { id: 'pair5', html: 'I = J' },
            { id: 'pair6', html: 'K ‚â† L' },
            // Trap/trick choices (do not match any pair)
            { id: 'trap1', html: 'A ‚â† B' },
            { id: 'trap2', html: 'C = D' },
            { id: 'trap3', html: 'E = F' },
            { id: 'trap4', html: 'G ‚â† H' },
            { id: 'trap5', html: 'I ‚â† J' },
            { id: 'trap6', html: 'K = L' }
        ];
        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }
        function renderMatchingGame() {
            const leftCol = document.querySelector('.matching-column:first-child');
            const rightCol = document.querySelector('.matching-column:last-child');
            // Remove all except title
            leftCol.innerHTML = '<div class="column-title">‡πÄ‡∏ã‡∏ï‡∏Ñ‡∏π‡πà</div>';
            rightCol.innerHTML = '<div class="column-title">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå</div>';
            shuffleArray(matchingPairs);
            shuffleArray(matchingAnswers);
            matchingPairs.forEach(pair => {
                const div = document.createElement('div');
                div.className = 'matching-item';
                div.dataset.id = pair.id;
                div.innerHTML = pair.html;
                div.onclick = function() { selectItem(this); };
                leftCol.appendChild(div);
            });
            // Show all (including traps)
            matchingAnswers.forEach(ans => {
                const div = document.createElement('div');
                div.className = 'matching-item';
                div.dataset.answer = ans.id;
                div.innerHTML = ans.html;
                div.onclick = function() { selectAnswer(this); };
                rightCol.appendChild(div);
            });
        }
        window.addEventListener('DOMContentLoaded', function() {
            renderMatchingGame();
            updateXPDisplay();
        });

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        window.addEventListener('load', initGame);

        function finishLesson() {
            if (gameData.gameScore === 6) {
                // Prevent double XP
                if (localStorage.getItem('lesson3_completed') === 'true') {
                    alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß XP ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ã‡πâ‡∏≥');
                    window.location.href = 'index.html';
                    return;
                }
                // Add XP and mark as completed
                let xp = parseInt(localStorage.getItem('setTheoryXP') || '0', 10);
                xp += 100;
                localStorage.setItem('setTheoryXP', xp);
                localStorage.setItem('lesson3_completed', 'true');
                // If index.html exposes setTheoryUtils, sync with it
                if (window.opener && window.opener.setTheoryUtils) {
                    window.opener.setTheoryUtils.addXP(100);
                    window.opener.setTheoryUtils.completeLessonFromChild(3);
                } else if (window.setTheoryUtils) {
                    window.setTheoryUtils.addXP(100);
                    window.setTheoryUtils.completeLessonFromChild(3);
                }
                alert('üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 3 ‡πÅ‡∏•‡πâ‡∏ß\n‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö 100 XP!');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            } else {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏ö‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');
            }
        }
    </script>
</body>
</html>