<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4: ‡∏™‡∏±‡∏ö‡πÄ‡∏ã‡∏ï</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@200;300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #06b6d4;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, var(--bg-light) 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: var(--bg-white);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            width: 50%;
            transition: width 0.3s ease;
        }
        .lesson-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        .xp-display {
            font-size: 1.1rem;
            color: var(--success-color);
            font-weight: 600;
            margin-top: 12px;
        }
        .theory-card {
            background: var(--bg-white);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
        }
        .theory-card h3 {
            color: var(--primary-color);
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .theory-content { line-height: 1.8; color: var(--text-primary); }
        .example-box {
            background: var(--bg-light);
            border-left: 4px solid var(--secondary-color);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 10px 10px 0;
        }
        .game-container {
            background: var(--bg-white);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
        }
        .game-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
            text-align: center;
        }
        .set-display {
            display: flex;
            justify-content: space-around;
            margin: 2rem 0;
            flex-wrap: wrap;
            gap: 2rem;
        }
        .set-box {
            background: var(--bg-light);
            border: 2px solid var(--secondary-color);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            min-width: 200px;
            box-shadow: var(--shadow-sm);
        }
        .set-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-weight: 600;
        }
        .set-content {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }
        .elements-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin: 1.5rem 0;
        }
        .element-button {
            background: #fff;
            border: 2px solid var(--primary-color);
            border-radius: 20px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Kanit', sans-serif;
            font-weight: 500;
            user-select: none;
        }
        .element-button:hover {
            background: #f0f4ff;
            transform: translateY(-2px);
        }
        .element-button.selected {
            background: var(--primary-color);
            color: white;
        }
        .element-button.correct {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }
        .element-button.incorrect {
            background: var(--error-color);
            border-color: var(--error-color);
            color: white;
        }
        .subset-question {
            background: #f0f4ff;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 2rem 0;
            text-align: center;
            font-size: 1.1rem;
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }
        .question-title {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-weight: 600;
        }
        .buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Kanit', sans-serif;
        }
        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .btn-secondary {
            background: #f5f5f5;
            color: var(--text-primary);
        }
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        .result-message {
            text-align: center;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            display: none;
        }
        .result-message.success {
            background: #d1fae5;
            color: var(--success-color);
            border: 2px solid var(--success-color);
        }
        .result-message.error {
            background: #fee2e2;
            color: var(--error-color);
            border: 2px solid var(--error-color);
        }
        .score-display {
            text-align: center;
            font-size: 1.3rem;
            color: var(--primary-color);
            margin: 2rem 0;
            font-weight: 600;
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--primary-color);
            animation: confetti-fall 3s linear infinite;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .lesson-title { font-size: 2rem; }
            .buttons { flex-direction: column; }
            .set-display { flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <h1 class="lesson-title">üîç ‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4: ‡∏™‡∏±‡∏ö‡πÄ‡∏ã‡∏ï</h1>
            <div class="xp-display">
                <span id="xp-display">XP: 0</span>
            </div>
        </div>

        <div class="theory-card">
            <h3>üìä ‡∏ó‡∏§‡∏©‡∏é‡∏µ‡∏™‡∏±‡∏ö‡πÄ‡∏ã‡∏ï</h3>
            <div class="theory-content">
                <p><strong>‡∏™‡∏±‡∏ö‡πÄ‡∏ã‡∏ï (Subset)</strong> ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏ã‡∏ï‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏ã‡∏ï‡∏≠‡∏∑‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢</p>
                
                <div class="example-box">
                    <strong>‡∏Ñ‡∏≥‡∏ô‡∏¥‡∏¢‡∏≤‡∏°:</strong><br>
                    A ‚äÜ B ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á A ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏ö‡πÄ‡∏ã‡∏ï‡∏Ç‡∏≠‡∏á B<br>
                    ‡∏ñ‡πâ‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á A ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á B ‡∏î‡πâ‡∏ß‡∏¢
                </div>

                <div class="example-box">
                    <strong>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:</strong><br>
                    ‚Ä¢ A = {1, 2} ‡πÅ‡∏•‡∏∞ B = {1, 2, 3, 4}<br>
                    ‚Ä¢ A ‚äÜ B ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ 1 ‚àà B ‡πÅ‡∏•‡∏∞ 2 ‚àà B<br>
                    ‚Ä¢ C = {1, 5} ‡πÅ‡∏•‡∏∞ D = {1, 2, 3, 4}<br>
                    ‚Ä¢ C ‚äÑ D ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ 5 ‚àâ D
                </div>

                <div class="example-box">
                    <strong>‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</strong><br>
                    1. ‚àÖ ‚äÜ A (‡πÄ‡∏ã‡∏ï‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏ö‡πÄ‡∏ã‡∏ï‡∏Ç‡∏≠‡∏á‡πÄ‡∏ã‡∏ï‡πÉ‡∏î‡πÜ)<br>
                    2. A ‚äÜ A (‡πÄ‡∏ã‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏ö‡πÄ‡∏ã‡∏ï‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)<br>
                    3. ‡∏ñ‡πâ‡∏≤ A ‚äÜ B ‡πÅ‡∏•‡∏∞ B ‚äÜ C ‡πÅ‡∏•‡πâ‡∏ß A ‚äÜ C
                </div>

                <div class="example-box">
                    <strong>‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå:</strong><br>
                    ‚Ä¢ A ‚äÜ B ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á A ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏ö‡πÄ‡∏ã‡∏ï‡∏Ç‡∏≠‡∏á B<br>
                    ‚Ä¢ A ‚äÑ B ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á A ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏ö‡πÄ‡∏ã‡∏ï‡∏Ç‡∏≠‡∏á B<br>
                    ‚Ä¢ A ‚äÇ B ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á A ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏ö‡πÄ‡∏ã‡∏ï‡πÅ‡∏ó‡πâ‡∏Ç‡∏≠‡∏á B
                </div>
            </div>
        </div>

        <div class="game-container">
            <h2 class="game-title">üéÆ ‡πÄ‡∏Å‡∏°‡∏™‡∏±‡∏ö‡πÄ‡∏ã‡∏ï: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ö‡πÄ‡∏ã‡∏ï</h2>
            
            <div class="score-display">
                ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="gameScore">0</span> / 5
            </div>

            <div style="text-align:center;margin-bottom:1.5rem;">
                <svg width="120" height="60" viewBox="0 0 120 60">
                    <ellipse cx="45" cy="30" rx="30" ry="20" fill="#4f46e5" fill-opacity="0.18"/>
                    <ellipse cx="75" cy="30" rx="30" ry="20" fill="#06b6d4" fill-opacity="0.18"/>
                    <text x="38" y="30" font-size="16" fill="#4f46e5" font-weight="bold">A</text>
                    <text x="80" y="30" font-size="16" fill="#06b6d4" font-weight="bold">B</text>
                </svg>
                <div style="color:#64748b;font-size:1rem;">‡∏†‡∏≤‡∏û‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏ã‡∏ï‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ö‡πÄ‡∏ã‡∏ï</div>
            </div>

            <div class="set-display">
                <div class="set-box">
                    <div class="set-title">‡πÄ‡∏ã‡∏ï‡πÄ‡∏≠‡∏Å‡∏†‡∏û U</div>
                    <div class="set-content">U = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10}</div>
                </div>
                <div class="set-box">
                    <div class="set-title">‡πÄ‡∏ã‡∏ï‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</div>
                    <div class="set-content" id="targetSet">{‡∏Ñ‡∏π‡πà, ‚â§6}</div>
                </div>
            </div>

            <div class="subset-question">
                <div class="question-title" id="questionTitle">
                    ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏π‡πà‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 6
                </div>
                <div class="elements-container">
                    <div class="element-button" data-value="1" onclick="toggleElement(this)">1</div>
                    <div class="element-button" data-value="2" onclick="toggleElement(this)">2</div>
                    <div class="element-button" data-value="3" onclick="toggleElement(this)">3</div>
                    <div class="element-button" data-value="4" onclick="toggleElement(this)">4</div>
                    <div class="element-button" data-value="5" onclick="toggleElement(this)">5</div>
                    <div class="element-button" data-value="6" onclick="toggleElement(this)">6</div>
                    <div class="element-button" data-value="7" onclick="toggleElement(this)">7</div>
                    <div class="element-button" data-value="8" onclick="toggleElement(this)">8</div>
                    <div class="element-button" data-value="9" onclick="toggleElement(this)">9</div>
                    <div class="element-button" data-value="10" onclick="toggleElement(this)">10</div>
                </div>
            </div>

            <div class="result-message" id="resultMessage"></div>

            <div class="buttons" id="questionButtons">
                <button class="btn btn-primary" id="checkBtn" onclick="checkSubset()">‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
                <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" style="display:none;">‚û°Ô∏è ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
                <button class="btn btn-primary" id="finishLessonBtn" onclick="finishLesson()" style="display:none;">üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                <button class="btn btn-secondary" onclick="resetGame()">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                <button class="btn btn-secondary" onclick="goHome()">üè† ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π</button>
            </div>

            <div style="text-align:center;margin-top:1.5rem;display:none;" id="nextBtn">
                <button class="btn btn-primary" onclick="nextQuestion()">‚û°Ô∏è ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            </div>
        </div>
    </div>

    <script>
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏°
        let gameData = {
            currentXP: 0,
            stars: 0,
            gameScore: 0,
            currentQuestion: 0,
            selectedElements: [],
            totalQuestions: 5
        };

        // ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
        const questions = [
            {
                title: "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏π‡πà‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 6",
                target: "{‡∏Ñ‡∏π‡πà, ‚â§6}",
                correctAnswer: [2, 4, 6],
                explanation: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 6 ‡∏Ñ‡∏∑‡∏≠ 2, 4, 6"
            },
            {
                title: "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 5",
                target: "{‡∏Ñ‡∏µ‡πà, >5}",
                correctAnswer: [7, 9],
                explanation: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 5 ‡∏Ñ‡∏∑‡∏≠ 7, 9"
            },
            {
                title: "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 3: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢ 3 ‡∏•‡∏á‡∏ï‡∏±‡∏ß",
                target: "{‡∏´‡∏≤‡∏£ 3 ‡∏•‡∏á‡∏ï‡∏±‡∏ß}",
                correctAnswer: [3, 6, 9],
                explanation: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢ 3 ‡∏•‡∏á‡∏ï‡∏±‡∏ß ‡∏Ñ‡∏∑‡∏≠ 3, 6, 9"
            },
            {
                title: "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 4: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞",
                target: "{‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞}",
                correctAnswer: [2, 3, 5, 7],
                explanation: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏∑‡∏≠ 2, 3, 5, 7"
            },
            {
                title: "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 5: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 4",
                target: "{<4}",
                correctAnswer: [1, 2, 3],
                explanation: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 4 ‡∏Ñ‡∏∑‡∏≠ 1, 2, 3"
            }
        ];

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏Å‡∏°
        function initGame() {
            loadProgress();
            loadQuestion();
            updateUI();
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
        function loadQuestion() {
            const question = questions[gameData.currentQuestion];
            document.getElementById('questionTitle').textContent = question.title;
            document.getElementById('targetSet').textContent = question.target;

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            gameData.selectedElements = [];
            const elements = document.querySelectorAll('.element-button');
            elements.forEach(element => {
                element.classList.remove('selected', 'correct', 'incorrect');
                element.onclick = function() { toggleElement(this); }; // Enable again
            });

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            document.getElementById('resultMessage').style.display = 'none';

            // Reset buttons
            document.getElementById('nextBtn').style.display = 'none';
            document.querySelector('#questionButtons button.btn-primary').style.display = '';
        }

        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
        function toggleElement(element) {
            const value = parseInt(element.dataset.value);
            
            if (element.classList.contains('selected')) {
                // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                element.classList.remove('selected');
                gameData.selectedElements = gameData.selectedElements.filter(v => v !== value);
            } else {
                // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                element.classList.add('selected');
                gameData.selectedElements.push(value);
            }
            
            playSound('click');
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏ö‡πÄ‡∏ã‡∏ï
        function checkSubset() {
            const question = questions[gameData.currentQuestion];
            const correctAnswer = question.correctAnswer;

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
            const selectedSorted = [...gameData.selectedElements].sort((a, b) => a - b);
            const correctSorted = [...correctAnswer].sort((a, b) => a - b);

            const isCorrect = selectedSorted.length === correctSorted.length && 
                            selectedSorted.every((val, index) => val === correctSorted[index]);

            const resultMessage = document.getElementById('resultMessage');
            const elements = document.querySelectorAll('.element-button');

            // Disable all element buttons
            elements.forEach(el => el.onclick = null);

            if (isCorrect) {
                resultMessage.textContent = `üéâ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ${question.explanation}`;
                resultMessage.className = 'result-message success';

                elements.forEach(element => {
                    const value = parseInt(element.dataset.value);
                    if (correctAnswer.includes(value)) {
                        element.classList.add('correct');
                    }
                });

                gameData.gameScore++;
                playSound('success');
            } else {
                resultMessage.textContent = `‚ùå ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ${question.explanation}`;
                resultMessage.className = 'result-message error';

                elements.forEach(element => {
                    const value = parseInt(element.dataset.value);
                    if (correctAnswer.includes(value)) {
                        element.classList.add('correct');
                    } else if (gameData.selectedElements.includes(value)) {
                        element.classList.add('incorrect');
                    }
                });

                playSound('error');
            }

            resultMessage.style.display = 'block';

            // Show next or finish button, hide check button
            document.getElementById('checkBtn').style.display = 'none';
            if (gameData.currentQuestion < gameData.totalQuestions - 1) {
                document.getElementById('nextBtn').style.display = '';
                document.getElementById('finishLessonBtn').style.display = 'none';
            } else {
                document.getElementById('nextBtn').style.display = 'none';
                document.getElementById('finishLessonBtn').style.display = '';
            }
        }

        function nextQuestion() {
            if (gameData.currentQuestion < gameData.totalQuestions - 1) {
                gameData.currentQuestion++;
                loadQuestion();
                playSound('click');
                updateScore();
            }
        }

        // ‡∏à‡∏ö‡πÄ‡∏Å‡∏°
        function finishGame() {
            gameData.currentXP += gameData.gameScore * 30;
            gameData.stars += Math.floor(gameData.gameScore / 2);
            
            const resultMessage = document.getElementById('resultMessage');
            resultMessage.textContent = `üéØ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏ñ‡∏π‡∏Å ${gameData.gameScore} ‡∏à‡∏≤‡∏Å ${gameData.totalQuestions} ‡∏Ç‡πâ‡∏≠`;
            resultMessage.className = 'result-message success';
            resultMessage.style.display = 'block';
            
            if (gameData.gameScore >= 4) {
                showConfetti();
                playSound('complete');
            }
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
            saveProgress();
            updateUI();
        }

        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡∏°
        function resetGame() {
            gameData.currentQuestion = 0;
            gameData.gameScore = 0;
            gameData.selectedElements = [];
            
            loadQuestion();
            updateScore();
            playSound('click');
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        function updateScore() {
            document.getElementById('gameScore').textContent = gameData.gameScore;
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
        function updateUI() {
            document.getElementById('currentXP').textContent = gameData.currentXP;
            document.getElementById('currentStars').textContent = gameData.stars;
            document.getElementById('progressFill').style.width = '50%'; // 4/8 lessons
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
        function loadProgress() {
            const saved = localStorage.getItem('setTheoryProgress');
            if (saved) {
                const savedData = JSON.parse(saved);
                gameData.currentXP = savedData.totalXP || 0;
                gameData.stars = savedData.totalStars || 0;
            }
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
        function saveProgress() {
            const saved = localStorage.getItem('setTheoryProgress');
            let progressData = saved ? JSON.parse(saved) : {
                totalXP: 0,
                completedLessons: 0,
                totalStars: 0,
                lessonProgress: {}
            };

            progressData.totalXP = gameData.currentXP;
            progressData.totalStars = gameData.stars;
            progressData.lessonProgress[4] = {
                completed: true,
                xp: gameData.gameScore * 30,
                stars: Math.floor(gameData.gameScore / 2)
            };

            // ‡∏ô‡∏±‡∏ö‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à
            progressData.completedLessons = Object.keys(progressData.lessonProgress).length;

            localStorage.setItem('setTheoryProgress', JSON.stringify(progressData));
        }

        // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        function playSound(type) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'success':
                    oscillator.frequency.value = 659.25; // E5
                    oscillator.type = 'sine';
                    gainNode.gain.value = 0.3;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                    break;
                    
                case 'complete':
                    // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à
                    oscillator.frequency.value = 523.25; // C5
                    oscillator.type = 'sine';
                    gainNode.gain.value = 0.3;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                    
                    setTimeout(() => {
                        const osc2 = audioContext.createOscillator();
                        const gain2 = audioContext.createGain();
                        osc2.connect(gain2);
                        gain2.connect(audioContext.destination);
                        osc2.frequency.value = 659.25; // E5
                        osc2.type = 'sine';
                        gain2.gain.value = 0.3;
                        osc2.start();
                        osc2.stop(audioContext.currentTime + 0.2);
                    }, 100);
                    break;
                    
                case 'error':
                    oscillator.frequency.value = 200;
                    oscillator.type = 'sawtooth';
                    gainNode.gain.value = 0.2;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;
                    
                case 'click':
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    gainNode.gain.value = 0.3;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                    break;
            }
        }

        // ‡πÅ‡∏™‡∏î‡∏á confetti
        function showConfetti() {
            const confetti = document.createElement('div');
            confetti.classList.add('confetti');
            document.body.appendChild(confetti);
            const colors = ['#4f46e5', '#06b6d4', '#10b981', '#f59e0b', '#ef4444'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const c = document.createElement('div');
                    c.className = 'confetti';
                    c.style.left = Math.random() * 100 + 'vw';
                    c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    c.style.animationDelay = Math.random() * 2 + 's';
                    document.body.appendChild(c);
                    setTimeout(() => { c.remove(); }, 3000);
                }, i * 50);
            }
            setTimeout(() => { confetti.remove(); }, 3000);
        }

        // ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        function goHome() {
            playSound('click');
            window.location.href = 'index.html';
        }

        // ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        function finishLesson() {
            // Only allow if all questions are answered correctly
            if (gameData.gameScore === gameData.totalQuestions) {
                // Prevent double XP
                if (localStorage.getItem('lesson4_completed') === 'true') {
                    alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß XP ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ã‡πâ‡∏≥');
                    window.location.href = 'index.html';
                    return;
                }
                // Add XP and mark as completed
                let xp = parseInt(localStorage.getItem('setTheoryXP') || '0', 10);
                xp += 100;
                localStorage.setItem('setTheoryXP', xp);
                localStorage.setItem('lesson4_completed', 'true');
                updateXPDisplay();
                // Sync with index.html if possible
                if (window.opener && window.opener.setTheoryUtils) {
                    window.opener.setTheoryUtils.addXP(100);
                    window.opener.setTheoryUtils.completeLessonFromChild(4);
                } else if (window.setTheoryUtils) {
                    window.setTheoryUtils.addXP(100);
                    window.setTheoryUtils.completeLessonFromChild(4);
                }
                showConfetti();
                document.getElementById('finishLessonBtn').disabled = true;
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
            } else {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô!');
            }
        }

        // XP SYSTEM (same as lesson 1)
        function getXP() {
            return parseInt(localStorage.getItem('setTheoryXP') || '0', 10);
        }
        function setXP(xp) {
            localStorage.setItem('setTheoryXP', xp);
            updateXPDisplay();
        }
        function addXP(amount) {
            let xp = getXP();
            xp += amount;
            setXP(xp);
        }
        function updateXPDisplay() {
            const xp = getXP();
            const el = document.getElementById('xp-display');
            if (el) el.textContent = `XP: ${xp}`;
        }
        window.addEventListener('DOMContentLoaded', updateXPDisplay);

        // Celebration effect (same as lesson 1)
        function showConfetti() {
            const confetti = document.createElement('div');
            confetti.classList.add('confetti');
            document.body.appendChild(confetti);
            const colors = ['#4f46e5', '#06b6d4', '#10b981', '#f59e0b', '#ef4444'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const c = document.createElement('div');
                    c.className = 'confetti';
                    c.style.left = Math.random() * 100 + 'vw';
                    c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    c.style.animationDelay = Math.random() * 2 + 's';
                    document.body.appendChild(c);
                    setTimeout(() => { c.remove(); }, 3000);
                }, i * 50);
            }
            setTimeout(() => { confetti.remove(); }, 3000);
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        window.addEventListener('load', initGame);
    </script>
</body>
</html>